# SDF Converter

CLI tool to extract historical attendance data from SQL Server Compact Edition (`.sdf`) files and export to PostgreSQL-compatible `.sql` files.

## Why?

SQL Server CE libraries only exist for .NET Framework. No viable Rust, Node.js, or Python alternatives exist for reading `.sdf` files.

## Workflow

```
SDF file  -->  SdfConverter.exe  -->  output.sql  -->  psql  -->  PostgreSQL
```

## Usage

### Interactive Mode (Double-click)

Simply double-click `SdfConverter.exe` and enter the path when prompted.

**Tip:** Place the `.sdf` file in the same folder as the `.exe` and just type the filename:

```
SDF Converter - Convert attendance data to PostgreSQL SQL

Enter path to .sdf file: attendance.sdf

Opening: attendance.sdf
Auto-detected table: CHECKINOUT (45,230 rows)

Reading records...
  [45230/45230] 100%

Writing to: attendance.sql
  [45230/45230] 100%

Export complete:
  Records exported: 45,230
  Output file: attendance.sql (2.3 MB)

Press any key to exit...
```

### Command Line

```bash
SdfConverter.exe <sdf-file> [options]

Options:
  --output, -o <path>    Output .sql file path (default: input.sql)
  --table <name>         Attendance table name (auto-detect if omitted)
  --schema <name>        PostgreSQL schema name (default: public)
  --verbose              Show detailed progress
  --upgrade              Upgrade older SQL Server CE database format to 4.0
  --password, -p <pwd>   Database password for encrypted SDF files
```

### Examples

```bash
# Simplest - place .sdf in same folder as .exe
SdfConverter.exe attendance.sdf

# Specify full path
SdfConverter.exe "C:\backup\attendance.sdf"

# Specify output and table
SdfConverter.exe "C:\backup\data.sdf" --table CHECKINOUT -o migration.sql

# Custom PostgreSQL schema with verbose output
SdfConverter.exe "C:\backup\data.sdf" --schema hr --verbose

# Older SQL CE database (v2.0/3.0/3.5) - upgrade to 4.0
SdfConverter.exe "C:\backup\old_data.sdf" --upgrade

# Password-protected database
SdfConverter.exe "C:\backup\encrypted.sdf" --password "secret123"

# Both upgrade and password
SdfConverter.exe "C:\backup\old_encrypted.sdf" --upgrade --password "secret123"
```

## Handling Legacy Databases

### Older SQL CE Versions

SDF files created with SQL Server CE 2.0, 3.0, 3.1, or 3.5 must be upgraded to 4.0 format. Use `--upgrade` to convert automatically. A backup (`.sdf.backup`) is created before upgrading.

### Encrypted Databases

Password-protected SDF files require `--password`. In interactive mode, you'll be prompted if a password is needed.

## Build

```bash
# Development
dotnet build

# Release - single .exe (~2.4 MB)
dotnet publish -c Release
```

Output: `bin/Release/net48/publish/SdfConverter.exe`

Copy `SdfConverter.exe` and `SdfConverter.exe.config` to your target machine.

## Import to PostgreSQL

```bash
psql -h localhost -U postgres -d attendance -f output.sql
```

Duplicates are handled via `ON CONFLICT DO NOTHING`. Migrated records have `source = 'sdf_migration'`.

## Requirements

- Windows (SQL Server CE is Windows-only)
- .NET Framework 4.8 runtime (or use self-contained build)

## Output Format

```sql
-- Generated by SdfConverter
-- Source: attendance.sdf
-- Table: CHECKINOUT
-- Records: 45,230

INSERT INTO public.attendance (device_uid, timestamp, verify_type, source)
VALUES
  (123, '2024-01-15 08:30:00+07', 1, 'sdf_migration'),
  (124, '2024-01-15 08:31:00+07', 1, 'sdf_migration')
ON CONFLICT (device_uid, timestamp) DO NOTHING;
```
